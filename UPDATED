import sys
import random
from PyQt5.QtWidgets import QApplication, QMainWindow
from PyQt5.QtCore import Qt, QTimer
from PyQt5.QtGui import QPainter, QColor, QFont

CELL_SIZE = 20
GRID_SIZE = 30
WINDOW_SIZE = CELL_SIZE * GRID_SIZE


class Snake:
    def __init__(self):
        center = GRID_SIZE // 2
        self.body = [(center, center)]
        self.direction = (1, 0)
        self.grow_pending = 0

    def move(self):
        head_x, head_y = self.body[0]
        dx, dy = self.direction

        # Movement WITHOUT wrap-around (wall collision will be detected)
        new_head = (head_x + dx, head_y + dy)
        self.body.insert(0, new_head)

        if self.grow_pending > 0:
            self.grow_pending -= 1
        else:
            self.body.pop()

    def change_direction(self, new_dir):
        opposite = (-self.direction[0], -self.direction[1])
        if new_dir != opposite:
            self.direction = new_dir

    def grow(self):
        self.grow_pending += 1


class Food:
    def __init__(self):
        self.position = self.random_position()

    def random_position(self):
        return (
            random.randint(0, GRID_SIZE - 1),
            random.randint(0, GRID_SIZE - 1),
        )

    def respawn(self):
        self.position = self.random_position()


class SnakeGame(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Snake with Collisions & Game Over")
        self.setFixedSize(WINDOW_SIZE, WINDOW_SIZE + 40)  # extra space for score

        self.init_game()

        self.timer = QTimer(self)
        self.timer.timeout.connect(self.game_loop)
        self.timer.start(100)

    def init_game(self):
        self.snake = Snake()
        self.food = Food()
        self.score = 0
        self.game_over = False

    def game_loop(self):
        if self.game_over:
            return

        self.snake.move()

        # Wall Collision
        head_x, head_y = self.snake.body[0]
        if head_x < 0 or head_x >= GRID_SIZE or head_y < 0 or head_y >= GRID_SIZE:
            self.trigger_game_over()

        # Self Collision
        if self.snake.body[0] in self.snake.body[1:]:
            self.trigger_game_over()

        # Food Collision
        if self.snake.body[0] == self.food.position:
            self.snake.grow()
            self.food.respawn()
            self.score += 10

        self.update()

    def trigger_game_over(self):
        self.game_over = True
        self.timer.stop()

    def keyPressEvent(self, event):
        if event.key() == Qt.Key_Up:
            self.snake.change_direction((0, -1))
        elif event.key() == Qt.Key_Down:
            self.snake.change_direction((0, 1))
        elif event.key() == Qt.Key_Left:
            self.snake.change_direction((-1, 0))
        elif event.key() == Qt.Key_Right:
            self.snake.change_direction((1, 0))
        elif event.key() == Qt.Key_Space and self.game_over:
            self.timer.start(100)
            self.init_game()
        elif event.key() == Qt.Key_Q:
            QApplication.quit()

    def paintEvent(self, event):
        painter = QPainter(self)

        # SCORE
        painter.setFont(QFont("Arial", 18))
        painter.drawText(10, WINDOW_SIZE + 30, f"Score: {self.score}")

        # GAME OVER SCREEN
        if self.game_over:
            painter.setFont(QFont("Arial", 40))
            painter.setPen(QColor(255, 0, 0))
            painter.drawText(80, WINDOW_SIZE // 2, "GAME OVER")

            painter.setFont(QFont("Arial", 20))
            painter.drawText(70, WINDOW_SIZE // 2 + 40, "Press SPACE to Restart")
            return

        # Draw snake
        painter.setBrush(QColor(0, 255, 0))
        for x, y in self.snake.body:
            painter.drawRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE)

        # Draw food
        painter.setBrush(QColor(255, 0, 0))
        fx, fy = self.food.position
        painter.drawRect(fx * CELL_SIZE, fy * CELL_SIZE, CELL_SIZE, CELL_SIZE)


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = SnakeGame()
    window.show()
    sys.exit(app.exec_())
